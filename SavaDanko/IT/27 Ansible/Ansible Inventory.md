#### Ansible Inventory
**Ansible Inventory** — это описание управляемых узлов (хостов) и их групп, с которыми работает Ansible.

В inventory указываются:
- хосты (имена или IP)
- группы (например, `web`, `db`)
- переменные (общие для группы или отдельные для хоста)
- иерархии (`children` для вложенных групп)

Форматы: INI, YAML, или динамические inventory (AWS, GCP, Kubernetes и др.).

**Пример (INI)**
```ini
[web]
web1 ansible_host=192.168.1.11 ansible_user=ubuntu
web2 ansible_host=192.168.1.12 ansible_user=ubuntu

[db]
db1 ansible_host=192.168.1.20 ansible_user=postgres

[all:vars]
ansible_ssh_private_key_file=~/.ssh/id_rsa
```

**Пример (YAML)**
```yaml
ungrouped:
  hosts:
    mail.example.com:
webservers:
  hosts:
    foo.example.com:
    bar.example.com:
dbservers:
  hosts:
    one.example.com:
    two.example.com:
    three.example.com:

```

**Default groups в Ansible** — это два системных инвентарных группы, которые создаются автоматически:
- all — содержит абсолютно все хосты из inventory,
- ungrouped — содержит хосты, которые не входят ни в одну пользовательскую группу.
Каждый хост всегда принадлежит как минимум к двум группам: `all` и либо `ungrouped`, либо какой-то другой указанной группе.

**Hosts in multiple groups в Ansible** — это возможность включать один и тот же хост сразу в несколько групп инвентаря.
```
webservers:
      hosts:
        app1.example.com:
        app2.example.com:
    dbservers:
      hosts:
        db1.example.com:
        app1.example.com:
    prod:
      hosts:
        app1.example.com:
        db1.example.com:
    test:
      hosts:
        app2.example.com:
```

**Ansible Parent/Child Groups** (вложенные группы) — это механизм, позволяющий объединять несколько групп в одну «родительскую».
Особенности:
- все хосты из дочерних групп автоматически входят в родительскую
- у группы может быть несколько родителей и детей, но нельзя создавать циклы
- данные хоста из разных групп объединяются
```yaml
web:
      hosts:
        app1.example.com:
        app2.example.com:
    db:
      hosts:
        db1.example.com:
    prod:
      children:
        web:
        db:
```

**Adding ranges of hosts в Ansible** — это возможность описывать множество хостов с одинаковым шаблоном имени через диапазоны, вместо того чтобы перечислять их вручную.

Поддерживается в INI и YAML inventory.
- Можно указывать числовые диапазоны (`[01:50]` → от `01` до `50`).
- Можно задавать шаг (stride) (`[01:50:2]` → каждый второй).
- Можно использовать буквенные диапазоны (`[a:f]` → `a`, `b`, …, `f`).
- Диапазоны всегда включительные (входят оба конца).
- Нули в начале (`01`, `02`…) можно указывать или опускать — это не влияет.
```yaml
webservers:
      hosts:
        www[01:05].example.com:
        www[10:20:5].example.com:
    dbservers:
      hosts:
        db-[a:c].example.com:
```

**Passing multiple inventory sources в Ansible** — это возможность использовать несколько inventory одновременно (статические файлы, директории, динамические скрипты и т. д.).

Это полезно, если нужно объединить разные окружения (например, staging и production) для одной операции.

Источники можно указать:
- прямо в командной строке (`-i` несколько раз)
- через переменную окружения `ANSIBLE_INVENTORY`
- или в конфигурации `ansible.cfg` (параметр `DEFAULT_HOST_LIST`)

Запустить playbook с двумя inventory:
```
ansible-playbook deploy.yml -i staging -i production
```

**Organizing inventory in a directory в Ansible** — это способ объединять несколько inventory-источников в одной папке, вместо одного длинного файла.
Зачем это нужно:
- большие inventory-файлы становятся трудны в поддержке
- удобно разделять по командам или проектам (каждый ведёт свой файл)
- можно смешивать разные типы inventory (статические INI/YAML, динамические скрипты, inventory-плагины)

Ansible воспринимает каталог как единый inventory-источник и агрегирует все найденные в нём файлы.

По умолчанию игнорируются некоторые расширения и каталоги (можно настроить через `INVENTORY_IGNORE_PATTERNS` и `INVENTORY_IGNORE_EXTS`).

Файлы читаются сверху вниз в алфавитном порядке.

Пример структуры каталога inventory:
```
inventory/
  openstack.yml        # inventory plugin для облака OpenStack
  dynamic-inventory.py # динамическое inventory (скрипт)
  on-prem              # статический inventory с локальными серверами
  parent-groups        # группировка хостов
```
Запуск playbook с этим inventory:
```
ansible-playbook site.yml -i inventory
```

**Managing inventory load order в Ansible** — это правило, определяющее, как Ansible загружает несколько inventory-источников:
- Inventory-файлы обрабатываются в том порядке, в котором они указаны.
- Хосты, группы и переменные добавляются последовательно по мере чтения файлов.
- Группы `all` и `ungrouped` добавляются автоматически в конце, если их нет.
- Порядок может иметь значение:
    - родительские и дочерние группы должны встречаться в правильной последовательности, иначе возможны ошибки парсинга
    - YAML и INI плагины удаляют пустые группы после обработки источника.
- Если переменная задана несколько раз, применяется последнее определение («last definition wins»).

**Adding variables to inventory в Ansible** — это возможность задавать переменные для отдельных хостов или групп прямо в inventory-файле.

Основные моменты:
- Переменные можно указывать непосредственно в inventory (INI или YAML).
- Более гибко и масштабируемо хранить их в отдельных файлах `host_vars/` и `group_vars/` (этим занимается встроенный плагин `host_group_vars`).
- Переменные позволяют задавать, например, пользователя для подключения, ключи SSH, пути, порты и параметры приложений.
    
Пример в YAML:
```yaml
all:
  children:
    web:
      hosts:
        web1.example.com:
          ansible_user: ubuntu
          ansible_ssh_private_key_file: ~/.ssh/id_rsa
      vars:
        app_port: 8080
```

**Inventory aliases в Ansible** — это возможность задавать хостам в inventory короткие имена (алиасы), отличные от их реального IP или FQDN.

Ключевые моменты:
- Внутренний идентификатор хоста в Ansible — это `inventory_hostname`.    
- Он может быть IP-адресом, FQDN или просто алиасом.
- Алиас позволяет указывать «удобное имя», а реальные параметры подключения (IP, порт, юзер, ключ) задавать через переменные.
- Один и тот же реальный хост можно прописать с разными алиасами, чтобы таргетировать его по-разному.
```yaml
all:
  hosts:
    jumper:
      ansible_host: 192.0.2.50
      ansible_port: 5555
      ansible_user: ubuntu
```

**Group variables в Ansible** — это механизм, позволяющий назначать переменные сразу всей группе хостов, вместо того чтобы повторять их для каждого хоста отдельно.
Особенности:
- Указываются в `:vars` (INI) или в блоке `vars:` (YAML).    
- Перед выполнением Ansible «сплющивает» все переменные до уровня хоста.
- Если хост входит в несколько групп, переменные объединяются; при конфликтах значение выбирается по внутренним правилам слияния.
```yaml
atlanta:
  hosts:
    host1:
    host2:
  vars:
    ntp_server: ntp.atlanta.example.com
    proxy: proxy.atlanta.example.com
```

**Organizing host and group variables в Ansible** — это способ вынести переменные из inventory в отдельные файлы и каталоги (`host_vars/` и `group_vars/`), чтобы сделать конфигурацию более структурированной и удобной для поддержки.

Основные моменты:
- Работает через плагин `host_group_vars` (входит в Ansible по умолчанию).
- Поддерживаются форматы `YAML`, `JSON`, или файлы без расширения.
- Переменные можно хранить:
    - в файле с именем группы или хоста,
    - в каталоге с подфайлами (Ansible загружает все файлы в алфавитном порядке).
- Можно подключать `group_vars/` и `host_vars/` рядом с playbook или внутри inventory.

Пример структуры каталогов
```
inventory/
  hosts.yml
group_vars/
  webservers.yml
  dbservers.yml
host_vars/
  app1.yml
  db1.yml
```

Пример содержимого `group_vars/webservers.yml`
```yaml
ntp_server: ntp.web.example.com
proxy: proxy.web.example.com
```

Пример содержимого `host_vars/app1.yml`
```yaml
app_port: 8080
debug: true
```

**How variables are merged в Ansible** — это правило объединения переменных из разных источников с учётом приоритета.

Основные моменты:
- Перед запуском play, Ansible «сплющивает» все переменные до уровня конкретного хоста.
- При конфликтах значения берётся переменная с наибольшим приоритетом.    
- Порядок приоритета (от низшего к высшему):
    1. Группа `all`
    2. Родительская группа
    3. Дочерняя группа
    4. Хост
- Для групп одного уровня Ansible по умолчанию использует алфавитный порядок: переменные из группы, загруженной позже, перекрывают предыдущие.
- Приоритет можно управлять через переменную `ansible_group_priority` (чем выше число, тем выше приоритет).
    
Пример
```yaml
a_group:
  vars:
    testvar: a
    ansible_group_priority: 10   # повышаем приоритет этой группы
b_group:
  vars:
    testvar: b
```
Если хост принадлежит и `a_group`, и `b_group`:
- без приоритета результат был бы `testvar == b` (алфавитный порядок)
- но благодаря `ansible_group_priority` результат теперь `testvar == a`

**Managing inventory variable load order в Ansible** — это управление приоритетом переменных из разных inventory-источников.  
Переменные загружаются и перекрываются в том порядке, в котором Ansible читает inventory. Последнее определение переменной имеет приоритет.

Правила
- Если указываешь несколько inventory через `-i`, порядок их передачи в командной строке определяет приоритет.
- Если inventory — это каталог, файлы читаются в алфавитном порядке. Чтобы управлять порядком, используют числовые префиксы (`01-`, `02-`, `03-`).
- При конфликте переменных значение из последнего обработанного файла становится финальным.

---
**Dynamic inventory в Ansible** — это механизм, позволяющий автоматически формировать список хостов и их переменных из внешних источников (например, облачных провайдеров, LDAP, CMDB, OpenStack, AWS, GCP и др.), вместо статических файлов.

Ключевые моменты:
- Используется, если инфраструктура динамическая (серверы появляются и удаляются).
- Поддерживается двумя способами:
    - inventory plugins (рекомендуется, современные и гибкие),
    - inventory scripts (устаревающий, но совместимый метод).
- Можно писать свои плагины для подключения новых источников.
- Для управления через GUI можно использовать AWX/Red Hat Ansible Automation Platform, где динамические inventory синхронизируются и доступны через веб/REST API.
